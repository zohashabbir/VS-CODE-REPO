trigger: none
pr: none

parameters:
  - name: NPM_REGISTRY
    displayName: "Custom NPM Registry"
    type: string
    default: "https://pkgs.dev.azure.com/monacotools/Monaco/_packaging/vscode/npm/registry/"
  - name: SCAN_WINDOWS
    displayName: "Scan Windows"
    type: boolean
    default: true
  - name: SCAN_LINUX
    displayName: "Scan Linux"
    type: boolean
    default: false
  - name: CARGO_REGISTRY
    displayName: "Custom Cargo Registry"
    type: string
    default: 'sparse+https://pkgs.dev.azure.com/monacotools/Monaco/_packaging/vscode/Cargo/index/'

variables:
  - name: NPM_REGISTRY
    value: ${{ parameters.NPM_REGISTRY }}
  - name: SCAN_WINDOWS
    value: ${{ eq(parameters.SCAN_WINDOWS, true) }}
  - name: SCAN_LINUX
    value: ${{ eq(parameters.SCAN_LINUX, true) }}
  - name: VSCODE_MIXIN_REPO
    value: microsoft/vscode-distro
  - name: skipComponentGovernanceDetection
    value: true
  - name: NPM_ARCH
    value: x64
  - name: VSCODE_ARCH
    value: x64
  - name: Codeql.enabled
    value: false # too slow while debugging
  - name: Codeql.TSAEnabled
    value: true
  - name: Codeql.TSAOptionsPath
    value: '$(Build.SourcesDirectory)\build\azure-pipelines\config\tsaoptions.json'
  - name: CARGO_REGISTRY
    value: ${{ parameters.CARGO_REGISTRY }}
  - group: 'API Scan'

stages:
  - stage: Windows
    condition: eq(variables.SCAN_WINDOWS, 'true')
    pool: 1es-windows-2019-x64
    jobs:
      - job: WindowsJob
        timeoutInMinutes: 0
        steps:
          # - task: CredScan@3
          #   continueOnError: true
          #   inputs:
          #     scanFolder: "$(Build.SourcesDirectory)"
          #     outputFormat: "pre"

          - task: NodeTool@0
            inputs:
              versionSource: fromFile
              versionFilePath: .nvmrc
              nodejsMirror: https://github.com/joaomoreno/node-mirror/releases/download

          - template: ./distro/download-distro.yml

          - task: AzureKeyVault@1
            displayName: "Azure Key Vault: Get Secrets"
            inputs:
              azureSubscription: "vscode-builds-subscription"
              KeyVaultName: vscode-build-secrets
              SecretsFilter: "github-distro-mixin-password"

          - powershell: |
              . build/azure-pipelines/win32/exec.ps1
              $ErrorActionPreference = "Stop"
              exec { npm config set registry "$env:NPM_REGISTRY" --location=project }
              # npm >v7 deprecated the `always-auth` config option, refs npm/cli@72a7eeb
              # following is a workaround for yarn to send authorization header
              # for GET requests to the registry.
              exec { Add-Content -Path .npmrc -Value "always-auth=true" }
              exec { yarn config set registry "$env:NPM_REGISTRY" }
            condition: and(succeeded(), ne(variables.NODE_MODULES_RESTORED, 'true'), ne(variables['NPM_REGISTRY'], 'none'))
            displayName: Setup NPM & Yarn

          - task: npmAuthenticate@0
            inputs:
              workingFile: .npmrc
            condition: and(succeeded(), ne(variables.NODE_MODULES_RESTORED, 'true'), ne(variables['NPM_REGISTRY'], 'none'))
            displayName: Setup NPM Authentication

          - powershell: |
              . build/azure-pipelines/win32/exec.ps1
              $ErrorActionPreference = "Stop"
              exec { node build/setup-npm-registry.js $env:NPM_REGISTRY }
            condition: and(succeeded(), ne(variables.NODE_MODULES_RESTORED, 'true'), ne(variables['NPM_REGISTRY'], 'none'))
            displayName: Setup NPM Registry

          - pwsh: |
              $includes = @'
                {
                  'target_defaults': {
                    'conditions': [
                      ['OS=="win"', {
                        'msvs_settings': {
                          'VCCLCompilerTool': {
                            'AdditionalOptions': [
                              '/Zi',
                              '/FS'
                            ],
                          },
                          'VCLinkerTool': {
                            'AdditionalOptions': [
                              '/profile'
                            ]
                          }
                        }
                      }]
                    ]
                  }
                }
              '@

              if (!(Test-Path "~/.gyp")) {
                mkdir "~/.gyp"
                echo $includes > "~/.gyp/include.gypi"
              }
            displayName: Create include.gypi

          # - task: CodeQL3000Init@0
          #   displayName: CodeQL Initialize
          #   condition: eq(variables['Codeql.enabled'], 'True')

          - powershell: |
              . build/azure-pipelines/win32/exec.ps1
              . build/azure-pipelines/win32/retry.ps1
              $ErrorActionPreference = "Stop"
              retry { exec { yarn --frozen-lockfile --check-files } }
            env:
              PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
              GITHUB_TOKEN: "$(github-distro-mixin-password)"
              CHILD_CONCURRENCY: 1
            displayName: Install dependencies

          - script: node build/azure-pipelines/distro/mixin-npm
            displayName: Mixin distro node modules

          - script: node build/azure-pipelines/distro/mixin-quality
            displayName: Mixin distro quality
            env:
              VSCODE_QUALITY: stable

          - script: node .build/distro/cli-patches/index.js
            displayName: Apply distro patches

          - task: Npm@1
            displayName: Download openssl prebuilt
            inputs:
              command: custom
              customCommand: pack @vscode-internal/openssl-prebuilt@0.0.11
              customRegistry: useFeed
              customFeed: "Monaco/openssl-prebuilt"
              workingDir: $(Build.ArtifactStagingDirectory)

          - powershell: |
              mkdir $(Build.ArtifactStagingDirectory)/openssl
              tar -xvzf $(Build.ArtifactStagingDirectory)/vscode-internal-openssl-prebuilt-0.0.11.tgz --strip-components=1 --directory=$(Build.ArtifactStagingDirectory)/openssl
            displayName: Extract openssl prebuilt

          - template: ./cli/install-rust-win32.yml
            parameters:
              targets:
                - x86_64-pc-windows-msvc

          - template: ./cli/cli-compile-debug.yml
            parameters:
              VSCODE_QUALITY: stable
              VSCODE_CLI_TARGET: x86_64-pc-windows-msvc
              VSCODE_CLI_ENV:
                OPENSSL_LIB_DIR: $(Build.ArtifactStagingDirectory)/openssl/x64-windows-static/lib
                OPENSSL_INCLUDE_DIR: $(Build.ArtifactStagingDirectory)/openssl/x64-windows-static/include
                RUSTFLAGS: "-C target-feature=+crt-static"

          # - powershell: yarn compile
          #   displayName: Compile

          # - task: CodeQL3000Finalize@0
          #   displayName: CodeQL Finalize
          #   condition: eq(variables['Codeql.enabled'], 'True')

          - powershell: yarn gulp "vscode-symbols-win32-$(VSCODE_ARCH)"
            env:
              GITHUB_TOKEN: "$(github-distro-mixin-password)"
            displayName: Download Symbols

          - task: CopyFiles@2
            displayName: 'Copy CLI to scanbin'
            inputs:
              SourceFolder: $(Build.SourcesDirectory)/cli/target
              Contents: |
                **\code.exe
                **\code.pdb
              TargetFolder: $(agent.builddirectory)\scanbin\cli
              flattenFolders: true
            condition: succeeded()

          - task: PSScriptAnalyzer@1
            inputs:
              Path: '$(Build.SourcesDirectory)'
              Settings: required
              Recurse: true

          # - task: BinSkim@4
          #   inputs:
          #     InputType: "Basic"
          #     Function: "analyze"
          #     TargetPattern: "guardianGlob"
          #     AnalyzeIgnorePdbLoadError: true
          #     AnalyzeTargetGlob: '$(agent.builddirectory)\scanbin\**.dll;$(agent.builddirectory)\scanbin\**.exe;$(agent.builddirectory)\scanbin\**.node'
          #     AnalyzeLocalSymbolDirectories: '$(agent.builddirectory)\scanbin\VSCode-win32-$(VSCODE_ARCH)\pdb'

          # - task: AntiMalware@4
          #   inputs:
          #     InputType: Basic
          #     ScanType: CustomScan
          #     FileDirPath: '$(Build.SourcesDirectory)'
          #     EnableServices: true
          #     SupportLogOnError: false
          #     TreatSignatureUpdateFailureAs: 'Warning'
          #     SignatureFreshness: 'OneDay'
          #     TreatStaleSignatureAs: 'Error'

          - task: CopyFiles@2
            displayName: 'Collect Symbols for API Scan'
            inputs:
              SourceFolder: $(Agent.BuildDirectory)
              Contents: 'scanbin\**\*.pdb'
              TargetFolder: '$(agent.builddirectory)\symbols'
              flattenFolders: true
            condition: succeeded()

          - task: APIScan@2
            inputs:
              softwareFolder: $(agent.builddirectory)\scanbin
              softwareName: 'vscode-client'
              softwareVersionNum: '1'
              symbolsFolder: 'SRV*http://symweb;$(agent.builddirectory)\symbols'
              isLargeApp: false
              toolVersion: 'Latest'
            displayName: Run ApiScan
            condition: succeeded()
            env:
              AzureServicesAuthConnectionString: $(apiscan-connectionstring)

          - task: PublishSecurityAnalysisLogs@3
            inputs:
              ArtifactName: CodeAnalysisLogs
              ArtifactType: Container
              PublishProcessedResults: false
              AllTools: true

          - task: TSAUpload@2
            inputs:
              GdnPublishTsaOnboard: true
              GdnPublishTsaConfigFile: '$(Build.SourcesDirectory)\build\azure-pipelines\config\tsaoptions.json'
